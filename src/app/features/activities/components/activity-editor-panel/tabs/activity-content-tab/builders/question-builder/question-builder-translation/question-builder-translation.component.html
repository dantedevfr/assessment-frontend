<div *ngIf="showTranslation" class="space-y-4">
  <!-- (Arriba) Traducción general -->
  <label class="block text-sm font-medium mb-1">Traducción</label>
  <textarea
    pTextarea
    rows="3"
    [ngModel]="translationText"
    (ngModelChange)="onTranslationChange($event)"
    class="w-full"
  ></textarea>

  <div class="flex justify-end">
    <p-button
      label="Traducir palabra por palabra"
      icon="pi pi-book"
      (click)="onOpenWordTranslation()"
      size="small"
      styleClass="p-button-text p-button-sm text-blue-600"
    />
  </div>

  <!-- Modal -->
  <p-dialog
    [(visible)]="showWordModal"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '800px', height: '80vh' }"
    [contentStyle]="{ 'overflow-y': 'auto' }"
    [closable]="false"
  >
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between w-full">
        <span class="font-bold whitespace-nowrap"
          >Traducción palabra por palabra</span
        >

        <div *ngIf="selectedWordIds.length > 1">
          <p-button
            label="Agrupar palabras seleccionadas"
            icon="pi pi-link"
            (click)="groupSelectedWords()"
            severity="success"
            size="small"
            styleClass="p-button-sm"
          />
        </div>
      </div>
    </ng-template>

    <div class="space-y-4 p-2">
      <div
        *ngIf="textHasChanged"
        class="flex items-center justify-between bg-yellow-100 rounded p-3 mb-4"
      >
        <span class="text-yellow-800 font-medium">
          El texto ha cambiado. Puedes regenerar las palabras si lo deseas.
        </span>
        <p-button
          label="Regenerar palabras"
          icon="pi pi-refresh"
          (click)="onRegenerateWords()"
          severity="warn"
          size="small"
        />
      </div>

      <!-- 🚨 No hay palabras -->
      <div
        *ngIf="tempWordBreakdown.length === 0"
        class="text-center text-gray-600 p-4"
      >
        No hay palabras para traducir.
      </div>
      <p-accordion [multiple]="true" [(value)]="accordionActiveValues">
        <ng-container *ngFor="let word of tempWordBreakdown; let i = index">
          <p-accordion-panel [value]="i">
            <!-- Header personalizado -->
            <div class="flex items-center justify-between w-full p-2">
                <!-- Grupo izquierdo: checkbox, chip, input, imagen -->
              <div class="flex items-center gap-3 flex-grow">
              <!-- Checkbox -->
              <p-checkbox
                [(ngModel)]="selectedWordIds"
                [value]="word.id"
                [binary]="false"
                (click)="onCheckboxClick($event)"
              ></p-checkbox>

              <!-- Chip -->
              <div class="flex-shrink-0 w-40 overflow-hidden">
                <span
                class="block w-full text-ellipsis whitespace-nowrap overflow-hidden"
                [pTooltip]="word.text"
                  tooltipPosition="top"
                >
                  <p-chip [label]="word.text" class="w-full" />
                </span>
              </div>

              <!-- Traducción -->
              <input
                pInputText
                [(ngModel)]="word.translations[0].translatedText"
                placeholder="Traducción"
                class="min-w-[200px] max-w-[250px] flex-1"
                />

              <!-- Botón Upload Imagen -->
                <p-fileupload
                  name="image[]"
                  mode="basic"
                  [showUploadButton]="false"
                  [showCancelButton]="false"
                  [auto]="true"
                  chooseIcon="pi pi-image"
                  chooseLabel=""
                  accept="image/*"
                  maxFileSize="1000000"
                  class="p-button-rounded p-button-text p-button-sm"
                  (onSelect)="onSelectWordImage($event, word)"
                ></p-fileupload>

              <!-- Previsualización de Imagen (o placeholder) -->
              <div class="flex items-center justify-center w-10 h-10">
                <ng-container *ngIf="getWordImageUrl(word); else noImage">
                  <img
                    [src]="getWordImageUrl(word)"
                    alt="Imagen subida"
                    class="w-10 h-10 object-cover rounded-md shadow-sm"
                    />
                </ng-container>
                <ng-template #noImage>
                  <div class="w-10 h-10 bg-gray-100 rounded-md"></div>
                  <!-- Placeholder vacío -->
                </ng-template>
              </div>
              </div>
              <!-- Botón para abrir/cerrar -->
              <button
                pButton
                type="button"
                class="p-button-rounded p-button-text p-button-sm"
                (click)="toggleAccordion(i, $event)"
                pTooltip="Mostrar/Ocultar Explicación"
                tooltipPosition="top"
              >
                <i
                  [class.pi]="true"
                  [class.pi-minus]="accordionActiveValues.includes(i)"
                  [class.pi-plus]="!accordionActiveValues.includes(i)"
                ></i>
              </button>
            </div>

            <!-- Contenido expandible -->
            <p-accordion-content>
              <div class="flex flex-col gap-4 p-2">
                <textarea
                  pTextarea
                  [(ngModel)]="word.translations[0].explanation"
                  placeholder="Explicación (opcional)"
                  class="w-full h-24 resize-none"
                ></textarea>

                <!-- 🎧 Audio Section -->
                <div class="p-3 bg-white rounded-md border border-gray-300">
                  <label class="text-sm font-medium text-gray-700 block mb-2"
                    >Audio</label
                  >
                  <div
                    class="relative w-full h-24 bg-white rounded-md border border-gray-300"
                    #waveformContainerRef
                    [id]="'waveform-' + word.id"
                  >
                    <ng-container *ngIf="!hasAudio(word)">
                      <div
                        class="absolute inset-0 flex items-center justify-center text-sm text-gray-400"
                      >
                        Sin audio
                      </div>
                    </ng-container>
                  </div>

                  <!-- Controles -->
                  <div class="flex items-center gap-4 mt-3">
                    <p-fileupload
                      name="audio[]"
                      mode="basic"
                      [showUploadButton]="false"
                      [showCancelButton]="false"
                      [auto]="true"
                      chooseIcon="pi pi-volume-up"
                      chooseLabel="Choose"
                      accept="audio/*"
                      maxFileSize="1000000"
                      class="p-button-sm"
                      (onSelect)="onSelectWordAudio($event, word)"
                    ></p-fileupload>

                    <button
                      pButton
                      class="p-button-rounded p-button-icon-only bg-green-500 hover:bg-green-600"
                      [icon]="isPlaying[word.id] ? 'pi pi-pause' : 'pi pi-play'"
                      (click)="togglePlay(word.id)"
                    ></button>
                  </div>

                  <!-- 🆕 Botón para desagrupar si es phrase -->
                  <div
                    *ngIf="word.type === 'phrase'"
                    class="flex justify-end pt-2"
                  >
                    <p-button
                      label="Desagrupar"
                      icon="pi pi-times"
                      severity="danger"
                      size="small"
                      styleClass="p-button-sm"
                      (click)="ungroupWord(word)"
                    />
                  </div>
                </div>
              </div>
            </p-accordion-content>
          </p-accordion-panel>
        </ng-container>
      </p-accordion>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-2">
        <p-button
          label="Cancelar"
          (click)="onCancelWordTranslation()"
          severity="secondary"
        />
        <p-button
          label="Guardar"
          (click)="onSaveWordTranslation()"
          severity="primary"
        />
      </div>
    </ng-template>
  </p-dialog>
</div>

<p-dialog
  [(visible)]="showGroupingModal"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '400px' }"
  header="Ordena las palabras"
>
  <p-orderList
    [value]="selectedWordsForGrouping"
    [dragdrop]="true"
    [metaKeySelection]="false"
  >
    <ng-template let-word pTemplate="item">
      <div class="flex items-center">
        <span class="font-medium">{{ word.text }}</span>
      </div>
    </ng-template>
  </p-orderList>

  <div class="flex justify-end mt-4 gap-2">
    <p-button
      label="Cancelar"
      severity="secondary"
      (click)="showGroupingModal = false"
    ></p-button>
    <p-button
      label="Confirmar agrupación"
      severity="success"
      (click)="confirmGrouping()"
    ></p-button>
  </div>
</p-dialog>
