<div *ngIf="showTranslation" class="space-y-4">

    <!-- (Arriba) Traducción general -->
    <label class="block text-sm font-medium mb-1">Traducción</label>
    <textarea
      pTextarea
      rows="3"
      [ngModel]="translationText"
      (ngModelChange)="onTranslationChange($event)"
      class="w-full"
    ></textarea>

    <div class="flex justify-end">
      <p-button
        label="Traducir palabra por palabra"
        icon="pi pi-book"
        (click)="onOpenWordTranslation()"
        size="small"
        styleClass="p-button-text p-button-sm text-blue-600"
      />
    </div>

    <!-- Modal -->
    <p-dialog
      [(visible)]="showWordModal"
      [modal]="true"
      [draggable]="false"
      [resizable]="false"
      [style]="{ width: '900px', height: '80vh' }"
      [contentStyle]="{ 'overflow-y': 'auto' }"
      [closable]="false"
    >
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between w-full">
        <span class="font-bold whitespace-nowrap">Traducción palabra por palabra</span>

        <div *ngIf="selectedWordIds.length > 1">
          <p-button
            label="Agrupar palabras seleccionadas"
            icon="pi pi-link"
            (click)="groupSelectedWords()"
            severity="success"
            size="small"
            styleClass="p-button-sm"
          />
        </div>
      </div>
    </ng-template>

      <div class="space-y-4 p-2">
        <div *ngIf="textHasChanged" class="flex items-center justify-between bg-yellow-100 rounded p-3 mb-4">
            <span class="text-yellow-800 font-medium">
              El texto ha cambiado. Puedes regenerar las palabras si lo deseas.
            </span>
            <p-button
              label="Regenerar palabras"
              icon="pi pi-refresh"
              (click)="onRegenerateWords()"
              severity="warn"
              size="small"
            />
          </div>


        <!-- 🚨 No hay palabras -->
        <div *ngIf="tempWordBreakdown.length === 0" class="text-center text-gray-600 p-4">
          No hay palabras para traducir.
        </div>
        <p-accordion [multiple]="true" [(value)]="accordionActiveValues">
          <ng-container *ngFor="let word of tempWordBreakdown; let i = index">
            <p-accordion-panel [value]="i">
              <!-- Header personalizado -->
              <div class="flex items-center gap-3 w-full p-2" >
                <!-- Checkbox -->
                <p-checkbox
                  [(ngModel)]="selectedWordIds"
                  [value]="word.id"
                  [binary]="false"
                  (click)="onCheckboxClick($event)"
                ></p-checkbox>

                <!-- Chip -->
                <div class="flex-shrink-0 w-40 overflow-hidden">
                  <span
                    class="block w-full text-ellipsis whitespace-nowrap overflow-hidden"
                    [pTooltip]="word.text"
                    tooltipPosition="top"
                  >
                    <p-chip [label]="word.text" class="w-full" />
                  </span>
                </div>

                <!-- Traducción -->
                <input
                  pInputText
                  [(ngModel)]="word.translations[0].translatedText"
                  placeholder="Traducción"
                  class="min-w-[150px] max-w-[250px] flex-1"
                />

                <!-- Botón Play -->
                <button
                  pButton
                  type="button"
                  icon="pi pi-play"
                  class="p-button-rounded p-button-text p-button-sm"
                  (click)="playAudio(word)"
                  pTooltip="Reproducir audio"
                  tooltipPosition="top"
                ></button>

                <!-- Botón Pause -->
                <button
                  pButton
                  type="button"
                  icon="pi pi-pause"
                  class="p-button-rounded p-button-text p-button-sm"
                  (click)="pauseAudio(word)"
                  pTooltip="Pausar audio"
                  tooltipPosition="top"
                ></button>

                <!-- Upload Imagen -->
                <div class="flex items-center gap-2">
                  <p-fileupload
                    name="demo[]"
                    mode="basic"
                    [showUploadButton]="false"
                    [showCancelButton]="false"
                    [auto]="true"
                    chooseIcon="pi pi-image"
                    chooseLabel=""
                    accept="image/*"
                    maxFileSize="1000000"
                    class="p-button-rounded p-button-text p-button-sm"
                    (onSelect)="onSelectWordImage($event, word)"
                  ></p-fileupload>

                  <!-- Previsualización de imagen -->
                  <img
                    *ngIf="getWordImageUrl(word)"
                    [src]="getWordImageUrl(word)"
                    alt="Imagen subida"
                    class="w-10 h-10 object-cover rounded-md shadow-sm"
                  />
                </div>

                <!-- Upload Audio (modificado para alinear bonito) -->
                <div class="flex items-center gap-2">
                  <p-fileupload
                    name="demo[]"
                    mode="basic"
                    [showUploadButton]="false"
                    [showCancelButton]="false"
                    [auto]="true"
                    chooseIcon="pi pi-volume-up"
                    chooseLabel=""
                    accept="audio/*"
                    maxFileSize="1000000"
                    class="p-button-rounded p-button-text p-button-sm"
                    (onSelect)="onSelectWordAudio($event, word)"
                  ></p-fileupload>

                  <!-- Icono si ya existe un audio subido -->
                  <i
                    *ngIf="hasAudio(word)"
                    class="pi pi-check-circle text-green-500"
                    pTooltip="Audio subido"
                    tooltipPosition="top"
                  ></i>
                </div>

                <!-- Botón para abrir/cerrar -->
                <button
                  pButton
                  type="button"
                  class="p-button-rounded p-button-text p-button-sm"
                  (click)="toggleAccordion(i, $event)"
                  pTooltip="Mostrar/Ocultar Explicación"
                  tooltipPosition="top"
                >
                <i [class.pi]="true" [class.pi-minus]="accordionActiveValues.includes(i)" [class.pi-plus]="!accordionActiveValues.includes(i)"></i>
              </button>
              </div>

              <!-- Contenido expandible -->
              <p-accordion-content>
                <div class="p-3 space-y-4">
                  <textarea
                    pTextarea
                    [(ngModel)]="word.translations[0].explanation"
                    placeholder="Explicación (opcional)"
                    class="w-full h-24 resize-none"
                  ></textarea>

                  <!-- 🔥 Mostrar imagen subida si existe -->
                  <div *ngIf="getWordImageUrl(word)" class="flex justify-center">
                    <img [src]="getWordImageUrl(word)" alt="Imagen subida" class="max-h-40 object-contain rounded shadow-md" />
                  </div>

                  <!-- 🆕 Botón para desagrupar si es phrase -->
                  <div *ngIf="word.type === 'phrase'" class="flex justify-end pt-2">
                    <p-button
                      label="Desagrupar"
                      icon="pi pi-times"
                      severity="danger"
                      size="small"
                      styleClass="p-button-sm"
                      (click)="ungroupWord(word)"
                    />
                  </div>
                </div>
              </p-accordion-content>
            </p-accordion-panel>
          </ng-container>
        </p-accordion>


      </div>

      <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
          <p-button label="Cancelar" (click)="onCancelWordTranslation()" severity="secondary" />
          <p-button label="Guardar" (click)="onSaveWordTranslation()" severity="primary" />
        </div>
      </ng-template>
    </p-dialog>

  </div>

  <p-dialog
  [(visible)]="showGroupingModal"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '400px' }"
  header="Ordena las palabras"
>
  <p-orderList
    [value]="selectedWordsForGrouping"
    [dragdrop]="true"
    [metaKeySelection]="false"
  >
    <ng-template let-word pTemplate="item">
      <div class="flex items-center">
        <span class="font-medium">{{ word.text }}</span>
      </div>
    </ng-template>
  </p-orderList>

  <div class="flex justify-end mt-4 gap-2">
    <p-button label="Cancelar" severity="secondary" (click)="showGroupingModal = false"></p-button>
    <p-button label="Confirmar agrupación" severity="success" (click)="confirmGrouping()"></p-button>
  </div>
</p-dialog>
