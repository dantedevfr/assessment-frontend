<div *ngIf="showTranslation" class="space-y-4">

    <!-- (Arriba) Traducci√≥n general -->
    <label class="block text-sm font-medium mb-1">Traducci√≥n</label>
    <textarea
      pTextarea
      rows="3"
      [ngModel]="translationText"
      (ngModelChange)="onTranslationChange($event)"
      class="w-full"
    ></textarea>

    <div class="flex justify-end">
      <p-button
        label="Traducir palabra por palabra"
        icon="pi pi-book"
        (click)="onOpenWordTranslation()"
        size="small"
        styleClass="p-button-text p-button-sm text-blue-600"
      />
    </div>

    <!-- Modal -->
    <p-dialog
      [(visible)]="showWordModal"
      [modal]="true"
      [draggable]="false"
      [resizable]="false"
      [style]="{ width: '700px', height: '80vh' }"
      [contentStyle]="{ 'overflow-y': 'auto' }"
      [closable]="false"
    >
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between w-full">
        <span class="font-bold whitespace-nowrap">Traducci√≥n palabra por palabra</span>

        <div *ngIf="selectedWordIds.length > 1">
          <p-button
            label="Agrupar palabras seleccionadas"
            icon="pi pi-link"
            (click)="groupSelectedWords()"
            severity="success"
            size="small"
            styleClass="p-button-sm"
          />
        </div>
      </div>
    </ng-template>

      <div class="space-y-4 p-2">
        <div *ngIf="textHasChanged" class="flex items-center justify-between bg-yellow-100 rounded p-3 mb-4">
            <span class="text-yellow-800 font-medium">
              El texto ha cambiado. Puedes regenerar las palabras si lo deseas.
            </span>
            <p-button
              label="Regenerar palabras"
              icon="pi pi-refresh"
              (click)="onRegenerateWords()"
              severity="warn"
              size="small"
            />
          </div>


        <!-- üö® No hay palabras -->
        <div *ngIf="tempWordBreakdown.length === 0" class="text-center text-gray-600 p-4">
          No hay palabras para traducir.
        </div>

        <!-- ‚ö° Accordion de palabras -->
        <p-accordion [multiple]="false" >
          <ng-container *ngFor="let word of tempWordBreakdown; let i = index">
            <p-accordion-panel [value]="i">
              <p-accordion-header>
                <ng-template #toggleicon let-active="active">
                  <i [class.pi]="true" [class.pi-minus]="active" [class.pi-plus]="!active"></i>
                </ng-template>
                <span class="flex items-center gap-2">
                  <!-- ‚¨ÖÔ∏è Checkbox aqu√≠ -->
                  <p-checkbox
                  [(ngModel)]="selectedWordIds"
                  [value]="word.id"
                  [binary]="false"
                  class="mr-2"
                  (click)="onCheckboxClick($event)"
                ></p-checkbox>
                <p-chip [label]="word.text" />

                </span>
              </p-accordion-header>

              <p-accordion-content>
                <div class="space-y-4">
                  <input
                    pInputText
                    [(ngModel)]="word.translations[0].translatedText"
                    placeholder="Traducci√≥n"
                    class="w-full"
                  />
                  <textarea
                    pTextarea
                    [(ngModel)]="word.translations[0].explanation"
                    rows="2"
                    placeholder="Explicaci√≥n (opcional)"
                    class="w-full"
                  ></textarea>

                  <!-- üì§ Upload -->
                  <p-fileupload
                    name="demo[]"
                    url="https://www.primefaces.org/cdn/api/upload.php"
                    (onSelect)="onSelectWordMedia($event, word)"
                    (onClear)="onClearUpload()"
                    (onRemove)="onClearUpload()"
                    [accept]="'image/*,audio/*,video/*'"
                    [multiple]="false"
                    maxFileSize="1000000"
                    mode="advanced"
                  >
                    <ng-template #empty>
                      <div>Arrastra los archivos aqu√≠ para subir.</div>
                    </ng-template>
                    <ng-template #content>
                      <ul *ngIf="uploadedWordFiles.length > 0">
                        <li *ngFor="let file of uploadedWordFiles">
                          {{ file.name }} - {{ file.size }} bytes
                        </li>
                      </ul>
                    </ng-template>
                  </p-fileupload>
                   <!-- üÜï Bot√≥n para desagrupar si es phrase -->
                   <div *ngIf="word.type === 'phrase'" class="flex justify-end pt-2">
                    <p-button
                      label="Desagrupar"
                      icon="pi pi-times"
                      severity="danger"
                      size="small"
                      styleClass="p-button-sm"
                      (click)="ungroupWord(word)"
                    />
                  </div>
                </div>
              </p-accordion-content>
            </p-accordion-panel>
          </ng-container>
        </p-accordion>

      </div>

      <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
          <p-button label="Cancelar" (click)="onCancelWordTranslation()" severity="secondary" />
          <p-button label="Guardar" (click)="onSaveWordTranslation()" severity="primary" />
        </div>
      </ng-template>
    </p-dialog>

  </div>

  <p-dialog
  [(visible)]="showGroupingModal"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '400px' }"
  header="Ordena las palabras"
>
  <p-orderList
    [value]="selectedWordsForGrouping"
    [dragdrop]="true"
    [metaKeySelection]="false"
  >
    <ng-template let-word pTemplate="item">
      <div class="flex items-center">
        <span class="font-medium">{{ word.text }}</span>
      </div>
    </ng-template>
  </p-orderList>

  <div class="flex justify-end mt-4 gap-2">
    <p-button label="Cancelar" severity="secondary" (click)="showGroupingModal = false"></p-button>
    <p-button label="Confirmar agrupaci√≥n" severity="success" (click)="confirmGrouping()"></p-button>
  </div>
</p-dialog>
