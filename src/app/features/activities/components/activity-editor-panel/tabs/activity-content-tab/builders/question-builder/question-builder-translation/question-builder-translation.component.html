<div *ngIf="showTranslation" class="space-y-4">

    <!-- (Arriba) Traducción general -->
    <label class="block text-sm font-medium mb-1">Traducción</label>
    <textarea
      pTextarea
      rows="3"
      [ngModel]="translationText"
      (ngModelChange)="onTranslationChange($event)"
      class="w-full"
    ></textarea>

    <div class="flex justify-end">
      <p-button
        label="Traducir palabra por palabra"
        icon="pi pi-book"
        (click)="onOpenWordTranslation()"
        size="small"
        styleClass="p-button-text p-button-sm text-blue-600"
      />
    </div>

    <!-- Modal -->
    <p-dialog
      [(visible)]="showWordModal"
      [modal]="true"
      [draggable]="false"
      [resizable]="false"
      [style]="{ width: '1600px', height: '80vh' }"
      [contentStyle]="{ 'overflow-y': 'auto' }"
      [closable]="false"
    >
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between w-full">
        <span class="font-bold whitespace-nowrap">Traducción palabra por palabra</span>

        <div *ngIf="selectedWordIds.length > 1">
          <p-button
            label="Agrupar palabras seleccionadas"
            icon="pi pi-link"
            (click)="groupSelectedWords()"
            severity="success"
            size="small"
            styleClass="p-button-sm"
          />
        </div>
      </div>
    </ng-template>

      <div class="space-y-4 p-2">
        <div *ngIf="textHasChanged" class="flex items-center justify-between bg-yellow-100 rounded p-3 mb-4">
            <span class="text-yellow-800 font-medium">
              El texto ha cambiado. Puedes regenerar las palabras si lo deseas.
            </span>
            <p-button
              label="Regenerar palabras"
              icon="pi pi-refresh"
              (click)="onRegenerateWords()"
              severity="warn"
              size="small"
            />
          </div>


        <!-- 🚨 No hay palabras -->
        <div *ngIf="tempWordBreakdown.length === 0" class="text-center text-gray-600 p-4">
          No hay palabras para traducir.
        </div>
        <p-accordion [multiple]="true" [(value)]="accordionActiveValues">
          <ng-container *ngFor="let word of tempWordBreakdown; let i = index">
            <p-accordion-panel [value]="i">
              <!-- Header personalizado -->
              <div class="flex items-center gap-3 w-full p-2" >
                <!-- Checkbox -->
                <p-checkbox
                  [(ngModel)]="selectedWordIds"
                  [value]="word.id"
                  [binary]="false"
                  (click)="onCheckboxClick($event)"
                ></p-checkbox>

                <!-- Chip -->
                <div class="flex-shrink-0 w-40 overflow-hidden">
                  <span
                    class="block w-full text-ellipsis whitespace-nowrap overflow-hidden"
                    [pTooltip]="word.text"
                    tooltipPosition="top"
                  >
                    <p-chip [label]="word.text" class="w-full" />
                  </span>
                </div>

                <!-- Traducción -->
                <input
                  pInputText
                  [(ngModel)]="word.translations[0].translatedText"
                  placeholder="Traducción"
                  class="min-w-[150px] max-w-[250px] flex-1"
                />

              <!-- Reproductor de Audio (siempre) -->
<!-- 🎵 Bloque de Audio + Rango de Tiempos -->
<div class="flex flex-col w-[300px] gap-2">
  <!-- Audio player -->
  <audio
    [src]="getWordAudioUrl(word) || ''"
    controls
    [attr.disabled]="!getWordAudioUrl(word) ? true : null"
    class="w-full h-8"
    (loadedmetadata)="onLoadedMetadata($event, word)"
  ></audio>

  <!-- Slider de tiempo (StartTime - EndTime basado en tu modelo) -->
  <div *ngIf="word.startTime !== undefined && word.endTime !== undefined" class="w-full">
    <p-slider
      [ngModel]="[word.startTime, word.endTime]"
      (ngModelChange)="onAudioRangeChange($event, word)"
      [range]="true"
      [min]="0"
      [max]="audioDurations[word.id] || 30"
      [step]="0.1"
      styleClass="w-full"
    ></p-slider>

    <!-- Mostrar valores actuales -->
    <div class="flex justify-between text-xs mt-1 px-1">
      <span>Inicio: {{ word.startTime | number:'1.1-1' }}s</span>
      <span>Fin: {{ word.endTime | number:'1.1-1' }}s</span>
    </div>
  </div>
</div>



              <!-- Botón Upload Audio -->
              <div class="flex items-center">
                <p-fileupload
                  name="audio[]"
                  mode="basic"
                  [showUploadButton]="false"
                  [showCancelButton]="false"
                  [auto]="true"
                  chooseIcon="pi pi-volume-up"
                  chooseLabel=""
                  accept="audio/*"
                  maxFileSize="1000000"
                  class="p-button-rounded p-button-text p-button-sm"
                  (onSelect)="onSelectWordAudio($event, word)"
                ></p-fileupload>
              </div>

                <!-- Botón Upload Imagen -->
<div class="flex items-center">
  <p-fileupload
    name="image[]"
    mode="basic"
    [showUploadButton]="false"
    [showCancelButton]="false"
    [auto]="true"
    chooseIcon="pi pi-image"
    chooseLabel=""
    accept="image/*"
    maxFileSize="1000000"
    class="p-button-rounded p-button-text p-button-sm"
    (onSelect)="onSelectWordImage($event, word)"
  ></p-fileupload>
</div>

<!-- Previsualización de Imagen (o placeholder) -->
<div class="flex items-center justify-center w-10 h-10">
  <ng-container *ngIf="getWordImageUrl(word); else noImage">
    <img
      [src]="getWordImageUrl(word)"
      alt="Imagen subida"
      class="w-10 h-10 object-cover rounded-md shadow-sm"
    />
  </ng-container>
  <ng-template #noImage>
    <div class="w-10 h-10 bg-gray-100 rounded-md"></div> <!-- Placeholder vacío -->
  </ng-template>
</div>



                <!-- Botón para abrir/cerrar -->
                <button
                  pButton
                  type="button"
                  class="p-button-rounded p-button-text p-button-sm"
                  (click)="toggleAccordion(i, $event)"
                  pTooltip="Mostrar/Ocultar Explicación"
                  tooltipPosition="top"
                >
                <i [class.pi]="true" [class.pi-minus]="accordionActiveValues.includes(i)" [class.pi-plus]="!accordionActiveValues.includes(i)"></i>
              </button>
              </div>

              <!-- Contenido expandible -->
              <p-accordion-content>
                <div class="p-3 space-y-4">
                  <textarea
                    pTextarea
                    [(ngModel)]="word.translations[0].explanation"
                    placeholder="Explicación (opcional)"
                    class="w-full h-24 resize-none"
                  ></textarea>

                  <!-- 🆕 Botón para desagrupar si es phrase -->
                  <div *ngIf="word.type === 'phrase'" class="flex justify-end pt-2">
                    <p-button
                      label="Desagrupar"
                      icon="pi pi-times"
                      severity="danger"
                      size="small"
                      styleClass="p-button-sm"
                      (click)="ungroupWord(word)"
                    />
                  </div>
                </div>
              </p-accordion-content>
            </p-accordion-panel>
          </ng-container>
        </p-accordion>


      </div>

      <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
          <p-button label="Cancelar" (click)="onCancelWordTranslation()" severity="secondary" />
          <p-button label="Guardar" (click)="onSaveWordTranslation()" severity="primary" />
        </div>
      </ng-template>
    </p-dialog>

  </div>

  <p-dialog
  [(visible)]="showGroupingModal"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '400px' }"
  header="Ordena las palabras"
>
  <p-orderList
    [value]="selectedWordsForGrouping"
    [dragdrop]="true"
    [metaKeySelection]="false"
  >
    <ng-template let-word pTemplate="item">
      <div class="flex items-center">
        <span class="font-medium">{{ word.text }}</span>
      </div>
    </ng-template>
  </p-orderList>

  <div class="flex justify-end mt-4 gap-2">
    <p-button label="Cancelar" severity="secondary" (click)="showGroupingModal = false"></p-button>
    <p-button label="Confirmar agrupación" severity="success" (click)="confirmGrouping()"></p-button>
  </div>
</p-dialog>
